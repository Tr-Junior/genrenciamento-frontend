
<div *ngIf="isAdmin" class="hide-on-small">
  <app-produc-registration-page></app-produc-registration-page>
</div>
<p-dialog header="Cadastrar Produto" [(visible)]="displayModal" [modal]="true" [style]="{width: '80vw'}" *ngIf="isAdmin">
  <app-produc-registration-page></app-produc-registration-page>
</p-dialog>

<div class="card m-2">
  <p-table class="" [value]="product" dataKey="_id" editMode="row" [tableStyle]="{'min-width': '50rem'}" [paginator]="true"
    [rows]="100" [showCurrentPageReport]="true" [tableStyle]="{ 'min-width': '50rem' }"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} produtos"
    [rowsPerPageOptions]="[100, 150, 200, 250, 350, 500]" [tableStyle]="{'min-width': '50rem'}"
    styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
      <div class="formgrid grid">
        <div class="col pr-0 mr-0 pl-0 ml-0">
          <span class="p-input-icon-left align-items-center justify-content-center">
            <i class="pi pi-search"></i>
            <input pTooltip="Digite o nome do produto para pesquisa" tooltipPosition="top"  class="search" pInputText type="text" [(ngModel)]="searchQuery" (ngModelChange)="search()"
              placeholder="Pesquisar produtos..." />
          </span>
          <p-button icon="pi pi-times" styleClass=" p-button-danger p-button-text" (onClick)="clearSearch()"
            [disabled]="!searchQuery"></p-button>
        </div>
        <div class="show-on-small">
          <button pButton type="button" icon="pi pi-plus" (click)="openModal()"  pTooltip="Novo produto"
            tooltipPosition="top"></button>
        </div>
        <button pButton type="button" icon="pi pi-file-excel" class="export-button p-button-success"
          (click)="exportToExcel()"  pTooltip="Exportar para excel"></button>
        <p-button icon="pi pi-file-excel" styleClass="p-button-success" class="pl-2 export-icon"
                    pTooltip="Exportar para excel"
          (click)="exportToExcel()" ></p-button>
      </div>

    </ng-template>
    <!-- Cabeçalho da tabela -->
    <ng-template pTemplate="header">
      <tr>
        <th style="text-align: center">#</th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Produto" tooltipPosition="top">Produto</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Estoque" tooltipPosition="top">Estoque</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Estoque mínimo" tooltipPosition="top">Estoque mínimo</span>
        </th>
        <th *ngIf="isAdmin" style="text-align: center">
          <span class="truncate" pTooltip="Custo" tooltipPosition="top">Custo</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Valor de venda" tooltipPosition="top">Valor de venda</span>
        </th>
        <th style="text-align: center">Opções</th>
      </tr>
    </ng-template>

    <!-- Corpo da tabela -->
    <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
      <tr [pEditableRow]="product" [attr.id]="'productRow_' + product._id">
        <td style="text-align: center">
          {{ri+1}}
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="text" [(ngModel)]="selectedProduct.title" required style="width: 100%;" [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              {{product.title}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input size="3" pInputText type="text" pKeyFilter="num" id="number"
                onkeypress="return event.charCode >= 48 && event.charCode <= 57" [(ngModel)]="selectedProduct.quantity"
                required [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              <div [ngClass]="{'outofstock': product.quantity === 0, 'lowstock': (product.quantity != 0 && product.quantity <= 10),'instock': product.quantity > 10}">
                <span *ngIf="product.quantity !== 0"
                      pTooltip="Quantidade no orçamento: {{ getQuantityInBudget(product._id).quantity }} | Cliente: {{ getQuantityInBudget(product._id).clients.join(', ') }}"
                      tooltipPosition="top">
                  {{ product.quantity }}
                </span>
                <span *ngIf="product.quantity === 0" class="badge">Fora de Estoque</span>
              </div>
            </ng-template>

          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input size="3" pInputText type="text" pKeyFilter="num" id="number"
                onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                [(ngModel)]="selectedProduct.min_quantity" required [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              <div class="min-stok">
                <span>{{ product.min_quantity }}</span>
              </div>
            </ng-template>
          </p-cellEditor>
        </td>
        <td *ngIf="isAdmin" style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <p-inputNumber [size]="6" pKeyFilter="num" inputId="currency-user" mode="currency" currency="BRL"
                locale="pt" [(ngModel)]="selectedProduct.purchasePrice"></p-inputNumber>
            </ng-template>
            <ng-template pTemplate="output">
              {{product.purchasePrice | currency}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <p-inputNumber [size]="6" pKeyFilter="num" id="number" inputId="currency-user" mode="currency"
                currency="BRL" locale="pt" [(ngModel)]="selectedProduct.price" [disabled]="!isAdmin"></p-inputNumber>
            </ng-template>
            <ng-template pTemplate="output">
              {{product.price | currency}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <div class="flex align-items-center justify-content-center gap-3">
            <!-- Botão Adicionar ao Carrinho -->
            <p-button *ngIf="!editing"
                      icon="pi pi-cart-plus"
                      styleClass="p-button-rounded p-button-success p-button-outlined"
                      pTooltip="Adicionar ao carrinho"
                      tooltipPosition="top"
                      (click)="addToCart(product)">
            </p-button>

            <!-- Botão Editar -->
            <button *ngIf="!editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pInitEditableRow
                    icon="pi pi-pencil"
                    pTooltip="Editar item"
                    tooltipPosition="top"
                    (click)="onRowEditInit(product)"
                    class="p-button-rounded p-button-warning p-button-outlined">
            </button>

            <!-- Botão Salvar -->
            <button *ngIf="editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pSaveEditableRow
                    icon="pi pi-check"
                    pTooltip="Salvar alterações"
                    tooltipPosition="top"
                    (click)="onRowEditSave(product)"
                    class="p-button-rounded p-button-text p-button-success mr-2">
            </button>

            <!-- Botão Cancelar -->
            <button *ngIf="editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pCancelEditableRow
                    icon="pi pi-times"
                    pTooltip="Cancelar edição"
                    tooltipPosition="top"
                    (click)="onRowEditCancel(product)"
                    class="p-button-rounded p-button-text p-button-danger">
            </button>

            <!-- Botão Excluir -->
            <p-button *ngIf="!editing && isAdmin"
                      icon="pi pi-trash"
                      styleClass="p-button-rounded p-button-danger p-button-outlined"
                      pTooltip="Excluir item"
                      tooltipPosition="top"
                      [swal]="{
                        title: 'atenção',
                        background: '#737373',
                        width: 300,
                        color:'#fff',
                        text: 'Deseja realmente excluir o produto: '+ product.title + '?',
                        showDenyButton: true,
                        denyButtonText: 'Não',
                        confirmButtonText: 'Sim',
                        icon: 'warning'
                      }"
                      (confirm)="delete(product._id)">
            </p-button>
          </div>
        </td>

      </tr>
    </ng-template>
  </p-table>
  <h5 class="uk-text-center" *ngIf="product.length == 0">Não há Produtos Cadastrados</h5>
</div>
<div *ngIf="isAdmin" class="hide-on-small">
  <app-produc-registration-page></app-produc-registration-page>
</div>
<p-dialog header="Cadastrar Produto" [(visible)]="displayModal" [modal]="true" [style]="{width: '80vw'}" *ngIf="isAdmin">
  <app-produc-registration-page></app-produc-registration-page>
</p-dialog>

<div class="card m-2">
  <p-table class="" [value]="product" dataKey="_id" editMode="row" [tableStyle]="{'min-width': '50rem'}" [paginator]="true"
    [rows]="100" [showCurrentPageReport]="true" [tableStyle]="{ 'min-width': '50rem' }"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} produtos"
    [rowsPerPageOptions]="[100, 150, 200, 250, 350, 500]" [tableStyle]="{'min-width': '50rem'}"
    styleClass="p-datatable-striped">
    <ng-template pTemplate="caption">
      <div class="formgrid grid">
        <div class="col pr-0 mr-0 pl-0 ml-0">
          <span class="p-input-icon-left align-items-center justify-content-center">
            <i class="pi pi-search"></i>
            <input pTooltip="Digite o nome do produto para pesquisa" tooltipPosition="top"  class="search" pInputText type="text" [(ngModel)]="searchQuery" (ngModelChange)="search()"
              placeholder="Pesquisar produtos..." />
          </span>
          <p-button icon="pi pi-times" styleClass=" p-button-danger p-button-text" (onClick)="clearSearch()"
            [disabled]="!searchQuery"></p-button>
        </div>
        <div class="show-on-small">
          <button pButton type="button" icon="pi pi-plus" (click)="openModal()"  pTooltip="Novo produto"
            tooltipPosition="top"></button>
        </div>
        <button pButton type="button" icon="pi pi-file-excel" class="export-button p-button-success"
          (click)="exportToExcel()"  pTooltip="Exportar para excel"></button>
        <p-button icon="pi pi-file-excel" styleClass="p-button-success" class="pl-2 export-icon"
                    pTooltip="Exportar para excel"
          (click)="exportToExcel()" ></p-button>
      </div>

    </ng-template>
    <!-- Cabeçalho da tabela -->
    <ng-template pTemplate="header">
      <tr>
        <th style="text-align: center">#</th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Produto" tooltipPosition="top">Produto</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Estoque" tooltipPosition="top">Estoque</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Estoque mínimo" tooltipPosition="top">Estoque mínimo</span>
        </th>
        <th *ngIf="isAdmin" style="text-align: center">
          <span class="truncate" pTooltip="Custo" tooltipPosition="top">Custo</span>
        </th>
        <th style="text-align: center">
          <span class="truncate" pTooltip="Valor de venda" tooltipPosition="top">Valor de venda</span>
        </th>
        <th style="text-align: center">Opções</th>
      </tr>
    </ng-template>

    <!-- Corpo da tabela -->
    <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
      <tr [pEditableRow]="product" [attr.id]="'productRow_' + product._id">
        <td style="text-align: center">
          {{ri+1}}
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="text" [(ngModel)]="selectedProduct.title" required style="width: 100%;" [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              {{product.title}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input size="3" pInputText type="text" pKeyFilter="num" id="number"
                onkeypress="return event.charCode >= 48 && event.charCode <= 57" [(ngModel)]="selectedProduct.quantity"
                required [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              <div [ngClass]="{'outofstock': product.quantity === 0, 'lowstock': (product.quantity != 0 && product.quantity <= 10),'instock': product.quantity > 10}">
                <span *ngIf="product.quantity !== 0">{{ product.quantity }}</span>
                <span *ngIf="product.quantity === 0" class="badge">Fora de Estoque</span>
              </div>
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input size="3" pInputText type="text" pKeyFilter="num" id="number"
                onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                [(ngModel)]="selectedProduct.min_quantity" required [disabled]="!isAdmin">
            </ng-template>
            <ng-template pTemplate="output">
              <div class="min-stok">
                <span>{{ product.min_quantity }}</span>
              </div>
            </ng-template>
          </p-cellEditor>
        </td>
        <td *ngIf="isAdmin" style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <p-inputNumber [size]="6" pKeyFilter="num" inputId="currency-user" mode="currency" currency="BRL"
                locale="pt" [(ngModel)]="selectedProduct.purchasePrice"></p-inputNumber>
            </ng-template>
            <ng-template pTemplate="output">
              {{product.purchasePrice | currency}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <p-cellEditor>
            <ng-template pTemplate="input">
              <p-inputNumber [size]="6" pKeyFilter="num" id="number" inputId="currency-user" mode="currency"
                currency="BRL" locale="pt" [(ngModel)]="selectedProduct.price" [disabled]="!isAdmin"></p-inputNumber>
            </ng-template>
            <ng-template pTemplate="output">
              {{product.price | currency}}
            </ng-template>
          </p-cellEditor>
        </td>
        <td style="text-align: center">
          <div class="flex align-items-center justify-content-center gap-3">
            <!-- Botão Adicionar ao Carrinho -->
            <p-button *ngIf="!editing"
                      icon="pi pi-cart-plus"
                      styleClass="p-button-rounded p-button-success p-button-outlined"
                      pTooltip="Adicionar ao carrinho"
                      tooltipPosition="top"
                      (click)="addToCart(product)">
            </p-button>

            <!-- Botão Editar -->
            <button *ngIf="!editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pInitEditableRow
                    icon="pi pi-pencil"
                    pTooltip="Editar item"
                    tooltipPosition="top"
                    (click)="onRowEditInit(product)"
                    class="p-button-rounded p-button-warning p-button-outlined">
            </button>

            <!-- Botão Salvar -->
            <button *ngIf="editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pSaveEditableRow
                    icon="pi pi-check"
                    pTooltip="Salvar alterações"
                    tooltipPosition="top"
                    (click)="onRowEditSave(product)"
                    class="p-button-rounded p-button-text p-button-success mr-2">
            </button>

            <!-- Botão Cancelar -->
            <button *ngIf="editing && isAdmin"
                    pButton
                    pRipple
                    type="button"
                    pCancelEditableRow
                    icon="pi pi-times"
                    pTooltip="Cancelar edição"
                    tooltipPosition="top"
                    (click)="onRowEditCancel(product)"
                    class="p-button-rounded p-button-text p-button-danger">
            </button>

            <!-- Botão Excluir -->
            <p-button *ngIf="!editing && isAdmin"
                      icon="pi pi-trash"
                      styleClass="p-button-rounded p-button-danger p-button-outlined"
                      pTooltip="Excluir item"
                      tooltipPosition="top"
                      [swal]="{
                        title: 'atenção',
                        background: '#737373',
                        width: 300,
                        color:'#fff',
                        text: 'Deseja realmente excluir o produto: '+ product.title + '?',
                        showDenyButton: true,
                        denyButtonText: 'Não',
                        confirmButtonText: 'Sim',
                        icon: 'warning'
                      }"
                      (confirm)="delete(product._id)">
            </p-button>
          </div>
        </td>

      </tr>
    </ng-template>
  </p-table>
  <h5 class="uk-text-center" *ngIf="product.length == 0">Não há Produtos Cadastrados</h5>
</div>
